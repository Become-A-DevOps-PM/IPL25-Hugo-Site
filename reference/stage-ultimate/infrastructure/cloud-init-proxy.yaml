#cloud-config
#
# Reverse Proxy Configuration
# - nginx for SSL termination and reverse proxy
# - fail2ban for SSH and HTTP protection
# - Self-signed SSL certificate
#

package_update: true
package_upgrade: true

packages:
  - nginx
  - fail2ban
  - openssl

write_files:
  # fail2ban configuration
  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 5

      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 5
      bantime = 3600

      [nginx-http-auth]
      enabled = true
      port = http,https
      filter = nginx-http-auth
      logpath = /var/log/nginx/error.log
      maxretry = 5
      bantime = 3600

      [nginx-botsearch]
      enabled = true
      port = http,https
      filter = nginx-botsearch
      logpath = /var/log/nginx/access.log
      maxretry = 2
      bantime = 86400

  # SSH hardening
  - path: /etc/ssh/sshd_config.d/hardening.conf
    content: |
      PasswordAuthentication no
      PermitRootLogin no
      MaxAuthTries 3
      ClientAliveInterval 300
      ClientAliveCountMax 2

  # SSL parameters (will be included by nginx site config)
  - path: /etc/nginx/snippets/ssl-params.conf
    content: |
      ssl_protocols TLSv1.2 TLSv1.3;
      ssl_prefer_server_ciphers on;
      ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
      ssl_session_timeout 1d;
      ssl_session_cache shared:SSL:50m;
      ssl_session_tickets off;
      ssl_dhparam /etc/ssl/certs/dhparam.pem;
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;

runcmd:
  # Generate self-signed SSL certificate
  - openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/flask-selfsigned.key -out /etc/ssl/certs/flask-selfsigned.crt -subj "/C=SE/ST=Stockholm/L=Stockholm/O=IPL25/CN=flask-app"

  # Generate DH parameters (this takes a few minutes)
  - openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048

  # Set proper permissions
  - chmod 600 /etc/ssl/private/flask-selfsigned.key

  # Enable and start fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Enable nginx (but don't start until configured)
  - systemctl enable nginx

  # Restart SSH to apply hardening
  - systemctl restart sshd

  # Log completion
  - echo "Proxy cloud-init completed at $(date)" >> /var/log/cloud-init-complete.log
