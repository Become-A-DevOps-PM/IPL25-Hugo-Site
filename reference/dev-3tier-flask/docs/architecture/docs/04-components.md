# Components (C3)

## Component Architecture by Tier

This document zooms into each tier to show the internal components and their relationships. The C4 model provides three component diagrams - one for each tier.

### C3 Views Available

| View | Tier | Shows |
|------|------|-------|
| C3-PresentationTier | Browser | HTML, CSS, Forms, Navigation |
| C3-ApplicationTier | Flask Server | nginx, Gunicorn, Blueprints, Services |
| C3-DataTier | PostgreSQL | Database schema |

---

## Tier 1: Presentation Components (Browser)

### Component Diagram

![](embed:C3-PresentationTier)

### What Runs in the Browser

| Component | Technology | Source | Purpose |
|-----------|------------|--------|---------|
| **HTML Pages** | HTML5 | Jinja2 templates | Document structure |
| **CSS Stylesheet** | CSS3 | `static/css/style.css` | Visual styling |
| **HTML Forms** | HTML Form Elements | `demo.html` | User input |
| **Navigation** | HTML Anchors | All templates | Page links |

### Browser Component Details

#### HTML Pages

The browser renders HTML documents generated by Jinja2 on the server:

- `landing.html` - Landing page with navigation links
- `demo.html` - Demo form with entry list
- `base.html` - Template inheritance base

**Structure:**
```html
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <main>
        <!-- Page content -->
    </main>
</body>
</html>
```

#### CSS Stylesheet

Single CSS file providing visual styling:

```css
/* style.css - Key sections */
body { font-family: Arial; max-width: 600px; margin: 50px auto; }
form { margin: 20px 0; }
input[type="text"] { padding: 10px; width: 300px; }
button { padding: 10px 20px; background: #007bff; }
.entry { padding: 10px; border-bottom: 1px solid #eee; }
```

#### HTML Forms

The demo page contains a form for creating entries:

```html
<form method="POST" action="/demo/">
    <input type="text" name="value" placeholder="Enter a value..." required>
    <button type="submit">Add Entry</button>
</form>
```

**Form Behavior:**
1. User enters text
2. Clicks "Add Entry"
3. Browser POSTs form data to `/demo/`
4. Server processes and redirects
5. Browser follows redirect

#### Navigation

HTML anchor elements for page navigation:

```html
<nav>
    <ul>
        <li><a href="/demo">Demo Application</a></li>
        <li><a href="/api/health">Health Check</a></li>
    </ul>
</nav>
```

---

## Tier 2: Application Components (Flask Server)

### Component Diagram

![](embed:C3-ApplicationTier)

### Application Component Inventory

| Layer | Component | Technology | Purpose |
|-------|-----------|------------|---------|
| **Infrastructure** | nginx | nginx | Reverse proxy, SSL |
| **Infrastructure** | Gunicorn | Gunicorn | WSGI server |
| **Application** | Flask App | Flask | App factory |
| **Routing** | Main Blueprint | Flask | Landing page (`/`) |
| **Routing** | Demo Blueprint | Flask | Demo form (`/demo`) |
| **Routing** | API Blueprint | Flask | JSON API (`/api/*`) |
| **Business Logic** | Entry Service | Python | CRUD operations |
| **Data Access** | Entry Model | SQLAlchemy | ORM mapping |
| **Templates** | Jinja2 Templates | Jinja2 | HTML generation |
| **Static** | Static Files | CSS | Stylesheets |

### Application Component Details

#### nginx (Reverse Proxy)

Handles incoming HTTPS requests:

```nginx
server {
    listen 443 ssl;
    ssl_certificate /etc/nginx/ssl/flask-app.crt;

    location / {
        proxy_pass http://127.0.0.1:5001;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /static {
        alias /opt/flask-app/app/static;
    }
}
```

**Responsibilities:**
- SSL termination (self-signed certificate)
- Proxy requests to Gunicorn
- Serve static files directly
- Add proxy headers

#### Gunicorn (WSGI Server)

Production HTTP server:

```bash
gunicorn --bind 0.0.0.0:5001 --workers 2 wsgi:app
```

**Responsibilities:**
- Process management (2 workers)
- Request handling
- Application loading

#### Flask App (Application Factory)

Creates and configures the application:

```python
def create_app(config_name='development'):
    app = Flask(__name__)
    app.config.from_object(config_map[config_name])

    db.init_app(app)
    migrate.init_app(app, db)

    app.register_blueprint(main_bp)
    app.register_blueprint(demo_bp)
    app.register_blueprint(api_bp)

    return app
```

#### Blueprints (Route Handlers)

Three blueprints organize routes:

| Blueprint | Prefix | Routes | Handler |
|-----------|--------|--------|---------|
| `main_bp` | `/` | `GET /` | `main.py` |
| `demo_bp` | `/demo` | `GET/POST /demo/` | `demo.py` |
| `api_bp` | `/api` | `GET /api/health`, `GET /api/entries` | `api.py` |

**Demo Blueprint Example:**
```python
@demo_bp.route('/', methods=['GET', 'POST'])
def index():
    if request.method == 'POST':
        value = request.form.get('value')
        if value:
            EntryService.create_entry(value)
        return redirect(url_for('demo.index'))

    entries = EntryService.get_recent_entries(limit=10)
    return render_template('demo.html', entries=entries)
```

#### Entry Service (Business Logic)

Encapsulates database operations:

```python
class EntryService:
    @staticmethod
    def create_entry(value):
        entry = Entry(value=value)
        db.session.add(entry)
        db.session.commit()
        return entry

    @staticmethod
    def get_recent_entries(limit=10):
        return Entry.query.order_by(Entry.created_at.desc()).limit(limit).all()
```

#### Entry Model (Data Access)

SQLAlchemy ORM model:

```python
class Entry(db.Model):
    __tablename__ = 'entries'

    id = db.Column(db.Integer, primary_key=True)
    value = db.Column(db.Text, nullable=False)
    created_at = db.Column(db.DateTime, default=lambda: datetime.now(timezone.utc))

    def to_dict(self):
        return {'id': self.id, 'value': self.value, 'created_at': self.created_at.isoformat()}
```

---

## Tier 3: Data Components (PostgreSQL)

### Component Diagram

![](embed:C3-DataTier)

### Database Schema

| Table | Column | Type | Constraints |
|-------|--------|------|-------------|
| `entries` | `id` | INTEGER | PRIMARY KEY |
| `entries` | `value` | TEXT | NOT NULL |
| `entries` | `created_at` | TIMESTAMP | DEFAULT now() |

### SQL Operations

| Operation | SQL | Python (SQLAlchemy) |
|-----------|-----|---------------------|
| Create | `INSERT INTO entries (value) VALUES (...)` | `db.session.add(entry)` |
| Read All | `SELECT * FROM entries ORDER BY created_at DESC` | `Entry.query.order_by(...).all()` |
| Read Recent | `SELECT * FROM entries ORDER BY created_at DESC LIMIT 10` | `Entry.query.limit(10).all()` |
| Count | `SELECT COUNT(*) FROM entries` | `Entry.query.count()` |

### Database Configuration

| Setting | Value |
|---------|-------|
| Host | `psql-flask-dev.postgres.database.azure.com` |
| Port | 5432 |
| Database | `flask` |
| SSL Mode | `require` |
| User | `adminuser` |

---

## Request Flow Through All Tiers

### Complete Request Lifecycle

```
1. USER ACTION (Tier 1)
   User clicks "Add Entry" button
        │
        ▼
2. FORM SUBMISSION (Tier 1 → Tier 2)
   Browser POSTs to /demo/
        │
        ▼
3. NGINX (Tier 2 - Infrastructure)
   SSL termination, proxy to Gunicorn
        │
        ▼
4. GUNICORN (Tier 2 - Infrastructure)
   Routes request to Flask app
        │
        ▼
5. DEMO BLUEPRINT (Tier 2 - Routing)
   @demo_bp.route('/') handles POST
        │
        ▼
6. ENTRY SERVICE (Tier 2 - Business Logic)
   EntryService.create_entry(value)
        │
        ▼
7. ENTRY MODEL (Tier 2 - Data Access)
   entry = Entry(value=value)
   db.session.add(entry)
        │
        ▼
8. POSTGRESQL (Tier 3)
   INSERT INTO entries (value, created_at) VALUES (...)
        │
        ▼
9. REDIRECT (Tier 2 → Tier 1)
   return redirect(url_for('demo.index'))
        │
        ▼
10. PAGE RENDER (Tier 2 → Tier 1)
    Jinja2 renders demo.html with entries
        │
        ▼
11. BROWSER DISPLAY (Tier 1)
    HTML page renders with new entry visible
```

### Next Level

See [Deployment](05-deployment.md) for how these components are deployed on Azure.
