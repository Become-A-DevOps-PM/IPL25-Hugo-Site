#cloud-config
# Combined cloud-init for nginx + Flask application server
# Installs: nginx, Python, fail2ban, and configures systemd service

package_update: true
package_upgrade: true

packages:
  - nginx
  - python3
  - python3-pip
  - python3-venv
  - postgresql-client
  - fail2ban
  - ufw

write_files:
  # nginx configuration - reverse proxy to Flask
  - path: /etc/nginx/sites-available/flask-app
    content: |
      # HTTP - redirect to HTTPS
      server {
          listen 80;
          server_name _;
          return 301 https://$host$request_uri;
      }

      # HTTPS - reverse proxy to Flask
      server {
          listen 443 ssl;
          server_name _;

          ssl_certificate /etc/nginx/ssl/nginx.crt;
          ssl_certificate_key /etc/nginx/ssl/nginx.key;
          ssl_protocols TLSv1.2 TLSv1.3;
          ssl_ciphers HIGH:!aNULL:!MD5;

          location / {
              proxy_pass http://127.0.0.1:5001;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }
      }
    owner: root:root
    permissions: '0644'

  # fail2ban configuration for SSH protection
  - path: /etc/fail2ban/jail.local
    content: |
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
      bantime = 3600
      findtime = 600
    owner: root:root
    permissions: '0644'

  # SSH hardening configuration
  - path: /etc/ssh/sshd_config.d/hardening.conf
    content: |
      PasswordAuthentication no
      PermitRootLogin no
      MaxAuthTries 3
    owner: root:root
    permissions: '0644'

  # Flask application systemd service
  - path: /etc/systemd/system/flask-app.service
    content: |
      [Unit]
      Description=Flask Application
      After=network.target

      [Service]
      Type=simple
      User=flask-app
      Group=flask-app
      WorkingDirectory=/opt/flask-app
      EnvironmentFile=/etc/flask-app/app.env
      ExecStart=/opt/flask-app/venv/bin/gunicorn --bind 127.0.0.1:5001 --workers 2 wsgi:app
      Restart=always
      RestartSec=5

      [Install]
      WantedBy=multi-user.target
    owner: root:root
    permissions: '0644'

runcmd:
  # Create flask-app system user
  - useradd --system --no-create-home --shell /usr/sbin/nologin flask-app

  # Create application directories
  - mkdir -p /opt/flask-app
  - mkdir -p /etc/flask-app
  - mkdir -p /etc/nginx/ssl

  # Create placeholder environment file (will be populated by deploy.sh)
  - |
    cat > /etc/flask-app/app.env << 'EOF'
    # Flask application environment variables
    # This file is populated by deploy.sh with DATABASE_URL
    FLASK_ENV=production
    EOF

  # Generate self-signed SSL certificate
  - openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/nginx/ssl/nginx.key -out /etc/nginx/ssl/nginx.crt -subj "/CN=flask-app"

  # Create Python virtual environment
  - python3 -m venv /opt/flask-app/venv
  - /opt/flask-app/venv/bin/pip install --upgrade pip wheel setuptools

  # Configure nginx
  - ln -sf /etc/nginx/sites-available/flask-app /etc/nginx/sites-enabled/flask-app
  - rm -f /etc/nginx/sites-enabled/default
  - nginx -t
  - systemctl reload nginx

  # Set permissions
  - chown -R azureuser:flask-app /opt/flask-app
  - chmod 775 /opt/flask-app
  - chown root:flask-app /etc/flask-app
  - chmod 750 /etc/flask-app
  - chown root:flask-app /etc/flask-app/app.env
  - chmod 640 /etc/flask-app/app.env

  # Enable and start fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Restart SSH to apply hardening (ssh.service on Ubuntu 24.04)
  - systemctl restart ssh

  # Reload systemd for flask-app service
  - systemctl daemon-reload

  # Create marker file to indicate cloud-init completed
  - touch /var/lib/cloud/instance/cloud-init-complete
